---
output: 
  pdf_document:
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
geometry: margin=2.54cm
title: "Insert title of project here"
subtitle: "https://github.com/xueying-F/ENV872-Project_XY_Feng"
author: "Xueying Feng"
fontsize: 12pt
mainfont: Times New Roman
editor_options: 
  chunk_output_type: inline
---

\newpage
\tableofcontents 
\newpage
\listoftables 
\newpage
\listoffigures 
\newpage

```{r setup, include=FALSE}
# Set your working directory
getwd()
setwd("~/Desktop/Environ 872/ENV872 Project_XY_Feng")

# Load your packages
library(plyr) #Tools for Splitting, Applying and Combining Data
library(tidyverse) #Getting data frames to tidy
library(lubridate) #For dates and date-times

require(ggplot2)
#install.packages("ggrepel") 
require(ggrepel)

#install.packages("usmap")
library(usmap)

# Set your ggplot theme
mytheme <- theme_minimal(base_size = 12, base_family = "Times") + 
  theme(axis.text.x = element_text(color = "DarkGrey"),
        legend.position = "top") 
theme_set(mytheme)

# Load your datasets
Historical_Global_processed <- read.csv("./Data/Processed/Historical_Global_processed.csv")
Historical_China_processed <- read.csv("./Data/Processed/Historical_China_processed.csv")
Covid19_Global_processed <- read.csv("./Data/Processed/Covid19_Global_processed.csv")
Covid19_China_processed <- read.csv("./Data/Processed/Covid19_China_processed.csv")
Covid19_US_processed <- read.csv("./Data/Processed/Covid19_US_processed.csv")

```


# Rationale and Research Questions



\newpage

# Dataset Information

## Database Information
I access all Novel Coronavirus data from the R package, nCov2019, which includes detailed real-time statistics, historical data in all countries, and down to the city-level.

More information can be found here:https://github.com/GuangchuangYu/nCov2019.


## Data Content Information

I pulled all relevent data from nCov2019 package. I named all pulled data as raw.csv and then saved into Data/Raw folder. Beside, I wrangled all raw and selected the relevent columns, and then saved into Data/Processed folder. In this project I will directly use the processed data.

The following tables are descriptions of my datasets:
```{r, table1, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
#install.packages("pander")
require(pander)
panderOptions('table.split.table', Inf)
set.caption("Historical_Global_processed dataset")
my.data <- "  Column name | Description 
 time | Date 
 country | Country name 
 cum_confirm | Cumulative number of COVID-19 confirmed cases  
 cum_heal | Cumulative number of COVID-19 heal cases 
 cum_dead | Cumulative number of COVID-19 death cases "
df <- read.delim(textConnection(my.data),header=FALSE,sep="|",strip.white=TRUE,stringsAsFactors=FALSE)
names(df) <- unname(as.list(df[1,])) # put headers on
df <- df[-1,] # remove first row
row.names(df)<-NULL
pander(df, style = 'rmarkdown')
```

```{r, table2, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
panderOptions('table.split.table', Inf)
set.caption("Historical_China_processed dataset")
my.data <- "  Column name | Description 
 time | Date 
 country | Country name 
 province | Province name 
 city | City name 
 cum_confirm | Cumulative number of COVID-19 confirmed cases  
 cum_heal | Cumulative number of COVID-19 heal cases 
 cum_dead | Cumulative number of COVID-19 death cases "
df <- read.delim(textConnection(my.data),header=FALSE,sep="|",strip.white=TRUE,stringsAsFactors=FALSE)
names(df) <- unname(as.list(df[1,])) # put headers on
df <- df[-1,] # remove first row
row.names(df)<-NULL
pander(df, style = 'rmarkdown')
```

```{r, table3, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
panderOptions('table.split.table', Inf)
set.caption("Covid19_Global_processed dataset")
my.data <- "  Column name | Description 
 name | Country name 
 confirm | Number of COVID-19 confirmed cases 
 dead | Number of COVID-19 death cases 
 deadRate | Total death number/ Cumulative total number of COVID-19 cases(%)
 heal | number of COVID-19 heal cases 
 healRate | Total heal number/ Cumulative total number of COVID-19 cases(%)"
df <- read.delim(textConnection(my.data),header=FALSE,sep="|",strip.white=TRUE,stringsAsFactors=FALSE)
names(df) <- unname(as.list(df[1,])) # put headers on
df <- df[-1,] # remove first row
row.names(df)<-NULL
pander(df, style = 'rmarkdown')
```

```{r, table4, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
panderOptions('table.split.table', Inf)
set.caption("Covid19_China_processed dataset")
my.data <- "  Column name | Description 
 name | Province name 
 confirm | Number of COVID-19 confirmed cases 
 dead | Number of COVID-19 death cases 
 deadRate | Total death number/ Cumulative total number of COVID-19 cases(%)
 heal | number of COVID-19 heal cases 
 healRate | Total heal number/ Cumulative total number of COVID-19 cases(%) "
df <- read.delim(textConnection(my.data),header=FALSE,sep="|",strip.white=TRUE,stringsAsFactors=FALSE)
names(df) <- unname(as.list(df[1,])) # put headers on
df <- df[-1,] # remove first row
row.names(df)<-NULL
pander(df, style = 'rmarkdown')
```

```{r, table5, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
panderOptions('table.split.table', Inf)
set.caption("Covid19_US_processed dataset")
my.data <- "  Column name | Description 
 time | Date |
 country | United States 
 province | States name 
 cum_confirm | Cumulative number of COVID-19 confirmed cases  
 cum_heal | Cumulative number of COVID-19 heal cases 
 cum_dead | Cumulative number of COVID-19 death cases "
df <- read.delim(textConnection(my.data),header=FALSE,sep="|",strip.white=TRUE,stringsAsFactors=FALSE)
names(df) <- unname(as.list(df[1,])) # put headers on
df <- df[-1,] # remove first row
row.names(df)<-NULL
pander(df, style = 'rmarkdown')
```

\newpage

# Exploratory Analysis 

## Explore China Dataset

```{r, echo =FALSE, fig.cap="Compare total number of each province in China"}
Covid19_China_processed <- read.csv("./Data/Processed/Covid19_China_processed.csv")

# scale_y_log10: transform the y-axis to make it easier to read
China.plot <-ggplot(Covid19_China_processed,aes(x = name,y = confirm)) + 
  geom_bar(size = 2, stat = "identity",position = "dodge", fill ="#fdae6b") + 
  scale_y_log10() +
  labs(x= "Province Name (China)",
       y = "Numbers of Confirmed Cases") + 
  mytheme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

China.plot
```

## Explore Global Dataset 

```{r}
Covid19_Global_processed <- read.csv("./Data/Processed/Covid19_Global_processed.csv")

# Filter out top 15 countries with the highest number of diagnoses
Fifty_countries <- Covid19_Global_processed %>% 
  top_n(15, confirm) %>%
  arrange(desc(confirm))

# Save as csv
write.csv(Fifty_countries,
          file = "./Data/Processed/Top_Fifty_countries (cum).csv", row.names=FALSE)
```

```{r, fig.cap=paste("Compare total number of each country"),echo = FALSE}
# Draw histogram plot
Global.plot <-ggplot(Fifty_countries,aes(x = name,y = confirm)) + 
  geom_bar(size = 2, stat = "identity",position = "dodge", fill ="#fdae6b") + 
  labs(x = " Country Name (Top 15)",
       y = "Numbers of Confirmed Cases") + 
  mytheme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(Global.plot)
```


\newpage

# Analysis

```{r, fig.cap=paste("Trend of confirmed case in China"), echo = FALSE}
#Selsct data from China
str(Historical_Global_processed)
Historical_China = Historical_Global_processed[Historical_Global_processed$country == 'China',]
head(Historical_China)

# Change date column to date
Historical_China$time <- as.Date(Historical_China$time, format = "%Y-%m-%d") 
class(Historical_China$time)

# Create a ggplot depicting cases incereasing over time
China_Trend <- 
  ggplot(Historical_China, aes(x=time, y=cum_confirm)) +
  geom_point(colour = "#e6550d") +
  geom_line(colour = "#d95f0e") +
  labs(x = "Time", 
       y = "Confirmed Cases") + 
  scale_x_date(date_labels = "%Y-%m-%d")

print(China_Trend)
```


### Analysis trend of each province in China 

```{r}
#Import datasets
Historical_China_processed <- read.csv("./Data/Processed/Historical_China_processed.csv",header = TRUE)

head(Historical_China_processed)
str(Historical_China_processed)

# Change date column to date
Historical_China_processed$time <- as.Date(Historical_China_processed$time, format = "%m/%d/%y") 
head(Historical_China_processed)
class(Historical_China_processed$time)

```

*Hubei Province*

```{r}
# Select Hubei province data
Historical_Hubei = Historical_China_processed[Historical_China_processed$province == 'Hubei',]
head(Historical_Hubei)

# Group by Hubei cities
Historical_HubeiCityV2 <- Historical_Hubei %>%
  select(time, city:cum_dead) 
# Save as csv
write.csv(Historical_HubeiCityV2,
          file = "./Data/Processed/Historical_HubeiCity.csv",row.names=FALSE)
```

```{r, fig.cap=paste("Trend of each city in Hubei province, China"), echo = FALSE}
# Create a ggplot depicting cases incereasing over time
HubeiCity_Trend <- ggplot(Historical_HubeiCityV2, aes(x=time, y=cum_confirm, color=city)) +
    geom_line(alpha = 0.95, size = 0.5) +
    geom_text_repel(aes(label=city),
                    function(Historical_HubeiCityV2) 
                      Historical_HubeiCityV2[Historical_HubeiCityV2$time == as.Date("2020-04-16"),])+
    mytheme +
    theme(legend.position = "none") +
    labs(x=expression(paste("Time"))) + 
    labs(y=expression(paste("Comfimed Cases")))+
    labs(color="city") +
    scale_x_date(date_labels = "%Y-%m-%d")

print(HubeiCity_Trend)
```


*Hubei Province (except Wuhan)*

```{r}
# Group by Hubei cities
Historical_HubeiCityV3 <- Historical_HubeiCityV2 %>%
  filter(city!= "Location TBD" & city!= "Wuhan") 

# Save as csv
write.csv(Historical_HubeiCityV3,
          file = "./Data/Processed/Historical_HubeiCity (except Wuhan).csv", row.names=FALSE)
```

```{r, fig.cap=paste("Trend of each city in Hubei province,China (except Wuhan)"),echo = FALSE}
# Create a ggplot depicting cases incereasing over time
HubeiCity_Trend <- ggplot(Historical_HubeiCityV3, aes(x=time, y=cum_confirm, color=city)) +
    geom_line(alpha = 0.95, size = 0.5) +
    geom_text_repel(aes(label=city),
                    function(Historical_HubeiCityV3) 
                      Historical_HubeiCityV3[Historical_HubeiCityV3$time == as.Date("2020-04-16"),])+
    mytheme +
    theme(legend.position = "none") +
    labs(x=expression(paste("Time"))) + 
    labs(y=expression(paste("Comfimed Cases")))+
    labs(color="city") +
    scale_x_date(date_labels = "%Y-%m-%d")

print(HubeiCity_Trend)
```


*Province in China (except Hubei)*

```{r}
# Remove Hubei province data
Historical_ChinaProvince = Historical_China_processed[Historical_China_processed$province != 'Hubei',]
head(Historical_ChinaProvince)

Historical_ChinaProvinceV2 <- Historical_ChinaProvince %>%
  group_by(time,province) %>%
  summarise(total_confirm = sum(cum_confirm),
            total_heal = sum(cum_heal),
            total_dead = sum(cum_dead)) 

# Save as csv
write.csv(Historical_ChinaProvinceV2,
          file = "./Data/Processed/Historical_ChinaProvince (except Hubei).csv", row.names=FALSE)
```

```{r, fig.cap=paste("Trend of each province in China (except Hubei)"),echo = FALSE}
# Create a ggplot depicting cases incereasing over time
ChinaProvince_Trend <- ggplot(Historical_ChinaProvinceV2, aes(x=time, y=total_confirm, color=province)) +
    geom_line(alpha = 0.95, size = 1) +
    geom_text_repel(aes(label=province),
                    function(Historical_ChinaProvinceV2) 
                      Historical_ChinaProvinceV2[Historical_ChinaProvinceV2$time == as.Date("2020-04-16"),])+
    mytheme +
    theme(legend.position = "none") +
    labs(x=expression(paste("Time"))) + 
    labs(y=expression(paste("Comfimed Cases"))) +
    labs(color="province") +
    scale_x_date(date_labels = "%Y-%m-%d")

print(ChinaProvince_Trend)
```


*Top ten province in China (except Hubei)*
```{r}
# Filter out the top ten provinces with the highest number of diagnoses (except Hubei)
TopTen_provinces <- Historical_ChinaProvinceV2 %>% 
  filter(time >= as.Date("2020-04-16")) %>%
  top_n(10, total_confirm) %>%
  arrange(desc(total_confirm)) 

TopTen_provinces <- pull(TopTen_provinces, province)

TenProvinces_China <- filter(Historical_ChinaProvinceV2, province %in% TopTen_provinces) %>%
  arrange(desc(total_confirm))

head(TenProvinces_China)

# Save as csv
write.csv(TenProvinces_China,
          file = "./Data/Processed/TenProvinces_China (except Hubei).csv", row.names=FALSE)
```

```{r, fig.cap=paste("Trend of top ten provinces, China (except Hubei)"), echo = FALSE}
# Draw plot
TenProvince_trend <- ggplot(TenProvinces_China, aes(x = time, y =total_confirm, color=province)) +
    geom_line(alpha = 0.95, size = 1) +
    geom_text_repel(aes(label=province),
                    function(Historical_ChinaProvinceV2) 
                      Historical_ChinaProvinceV2[Historical_ChinaProvinceV2$time == as.Date("2020-04-16"),])+
    mytheme +
    theme(legend.position = "none") +
    labs(x=expression(paste("Time"))) + 
    labs(y=expression(paste("Comfimed Cases"))) +
    labs(color="province") +
    scale_x_date(date_labels = "%Y-%m-%d")

print(TenProvince_trend)
```


*Top ten countries (global level except China)*

```{r cars}
# Check on data frame
head(Historical_Global_processed)
str(Historical_Global_processed)

# Change date column to date
Historical_Global_processed$time <- as.Date(Historical_Global_processed$time, format = "%Y-%m-%d") 
class(Historical_Global_processed$time)

# Remove China data
Historical_Global = Historical_Global_processed[Historical_Global_processed$country != 'China',]
str(Historical_Global)

# Filter out the top ten countries with the highest number of diagnoses (except China)
TopTen_countries <- Historical_Global %>% 
  filter(time >= as.Date("2020-04-16")) %>%
  top_n(10, cum_confirm) %>%
  arrange(desc(cum_confirm)) 

# Selects a column in a data frame and transforms it into a vector
TopTen_countries <- pull(TopTen_countries, country)

Historical_TopTen <- filter(Historical_Global, country %in% TopTen_countries) %>%
  arrange(desc(cum_confirm))
head(Historical_TopTen)

# Save as csv
write.csv(Historical_TopTen,
          file = "./Data/Processed/TopTen_countries_trend(except China).csv", row.names=FALSE)
```

```{r, fig.cap=paste("Trend of Top Ten Countries (except China)"), echo = FALSE}

# Draw plot
TenCountries <- ggplot(Historical_TopTen, aes(x = time, y =cum_confirm, color=country)) +
    geom_line(alpha = 0.95, size = 1) +
    geom_text_repel(aes(label=country),
                    function(Historical_TopTen) 
                      Historical_TopTen[Historical_TopTen$time == as.Date("2020-04-16"),])+
    mytheme +
    theme(legend.position = "none") +
    labs(x=expression(paste("Time"))) + 
    labs(y=expression(paste("Comfimed Cases"))) +
    labs(color="Country") +
    scale_x_date(date_labels = "%Y-%m-%d")

print(TenCountries)
```


## Question 1: <insert specific question here and add additional subsections for additional questions below, if needed>

## Question 2: 




\newpage

# Summary and Conclusions


\newpage

# References

Tianzhi Wu, Erqiang Hu, Xijin Ge*, Guangchuang Yu*. Open-source analytics tools for studying the COVID-19 coronavirus outbreak. medRxiv, 2020.02.25.20027433. doi: https://doi.org/10.1101/2020.02.25.20027433*
